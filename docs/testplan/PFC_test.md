# SONiC Switch PFC Test

- [SONiC Switch PFC Test](#sonic-switch-pfc-test)
  - [Test Objective](#test-objective)
  - [Background](#background)
    - [PFC Overview](#pfc-overview)
    - [PFC Pause Frame Rate](#pfc-pause-frame-rate)
    - [Lossless vs. Lossy Priority Queues](#lossless-vs-lossy-priority-queues)
  - [Test Setup](#test-setup)
  - [Test Steps](#test-steps)
  - [Expected Behaviors](#expected-behaviors)

## Test Objective

This test aims to verify that SONiC switch ports properly respond to PFC (Priority Flow Control) frames, and evaluate the impact on traffic classes with and without PFC enabled.

## Background

### PFC Overview

PFC pause frames are used to prevent a switch from transmitting data in a specific priority queue for a defined time interval. Each PFC frame includes an 8-bit field called the class-enable vector, where each bit corresponds to a priority queue. A bit value of 1 indicates that the associated priority should pause, while a value of 0 means it remains unaffected. To enforce the pause, the PFC frame must also specify the pause duration for the priority in question. This is done through pause duration fields, each representing one priority. Each duration is a 2-byte value expressed in quanta, where one quanta equals the time required to transmit 512 bits at the current network speed. For instance, a pause duration of 65535 quanta on a 100Gbps link translates to:
$$
\frac{65535 \times 512 \text{ bits}}{100 \text{ Gbps}} = 335.54 \, \mu s
$$

A pause duration of zero quanta has a special meaning—it signals that the priority queue should resume transmission.

### PFC Pause Frame Rate

To completely block a switch queue, PFC pause frames must be generated at a sufficient frequency to maintain the pause. In the example above, each port must receive PFC frames at a rate of:
$$
\frac{10^6}{335.54} \times 64 \approx 190,738 \text{ frames per second}
$$

### Lossless vs. Lossy Priority Queues

Only lossless priority queues are capable of reacting to or generating PFC frames. Traffic with lossy priority queues should not be affected by PFC frames.

## Test Setup

The reserved multicast address 01-80-C2-00-00-01 is used as the destination MAC address for PFC frames. This address is special in that it will not be forwarded by an 802.1D-compliant switch. Consequently, if PFC frames are generated by IXIA devices (as in 1-tier PFC tests), they will not reach T1 devices. Therefore, when the DUT is a T1 switch, we require at least one T0 switch that matches the model and build of the DUT, so that we can use T0 switch ports as replacements for testing. Additionally, every Ethernet port of the T0 switch must be connected to a PFC pause frame generator.

## Test Steps

```json
    "PORT_QOS_MAP": {
        "Ethernet0": {
            "dscp_to_tc_map": "AZURE",
            "pfc_enable": "3,4",
            "pfc_to_queue_map": "AZURE",
            "pfcwd_sw_enable": "3,4",
            "tc_to_pg_map": "AZURE",
            "tc_to_queue_map": "AZURE"
        }
    },
    "TC_TO_QUEUE_MAP": {
        "AZURE": {
            "0": "0",
            "1": "1",
            "2": "2",
            "3": "3",
            "4": "4",
            "5": "5",
            "6": "6",
            "7": "7"
        }
    },
    "QUEUE": {
        "Ethernet0|0": {
            "scheduler": "scheduler.0"
        },
        "Ethernet0|1": {
            "scheduler": "scheduler.0"
        },
        "Ethernet0|2": {
            "scheduler": "scheduler.0"
        },
        "Ethernet0|3": {
            "scheduler": "scheduler.1",
            "wred_profile": "AZURE_LOSSLESS"
        },
        "Ethernet0|4": {
            "scheduler": "scheduler.1",
            "wred_profile": "AZURE_LOSSLESS"
        },
        "Ethernet0|5": {
            "scheduler": "scheduler.0"
        },
        "Ethernet0|6": {
            "scheduler": "scheduler.0"
        }
    }
```

1. To prevent the DUT from dropping packets due to persistent PFC pause storms, disable the PFC watchdog on the SONiC DUT using the command `sudo pfcwd stop`.
2. Retrieve the lossless and lossy priority queues configured on the DUT by examining the PORT_QOS_MAP, TC_TO_QUEUE_MAP, and QUEUE configuration for the first port from config_DB (refer to the example above).
3. Identify the traffic generator and its corresponding port connected to the port under test—this serves as the Rx port for the traffic flows. Then, on a separate traffic generator that is not connected to the port, select a Tx port for the traffic flows. Assume there are X priority queues in the port configuration. Define X data traffic flows at line rate, ensuring their DSCP values match the priority settings on the DUT.
4. Calculate the required PFC frame rate based on the pause duration, link speed, and number of links. Assume Y priority queues of the port have PFC enabled. On the traffic generator where the above Rx port resides, define Y flows of PFC pause frames. Ensure the direction of the PFC pause frames is the opposite to the data traffic. The PFE pause frame's a class-enable vector must align with the priority settings.
5. Start generating PFC pause frames.
6. Start the X data traffic flows simultaneously.
7. Monitor and collect the Rx traffic rate and packet loss rate for each data traffic flow.
8. Stop the X data traffic flows.
9. Stop PFC pause frames.
10. Move to the next port and repeat the above steps until all ports have been tested.
11. Start all PFC pause frames. Then start all traffic flows across all ports to place the DUT under stress. Verify if the Rx traffic rates remain as expected under full load.

## Expected Behaviors

1. Data traffic transmitted through PFC-disabled queues should remain unaffected by PFC pause frames and maintain a 0% packet loss rate.
2. Data Traffic transmitted through PFC-enabled queues and lossless priorities is expected to experience a 0% Rx rate on the traffic generator as a result of the PFC pause frames.

## Metrics

Save the PFC test result to a database via the final metrics reporter interface provided by the SONiC team in `test_reporting` folder. An example of how to use the interface is provided in `telemetry` folder.

| User Interface Label                   | Label Key in DB          | Example Value       |
| -------------------------------------- | ------------------------ | ------------------- |
| `METRIC_LABEL_DEVICE_ID`               | device.id                | switch-A            |
| `METRIC_LABEL_DEVICE_PORT_ID`          | device.port.id           | Ethernet8           |

| User Interface Metric Name             | Metric Name in DB        | Example Value       |
| -------------------------------------- | ------------------------ | ------------------- |
| `METRIC_NAME_PFC_LOSSY`                | pfc.lossy                | FINAL_STATUS.PASS   |
