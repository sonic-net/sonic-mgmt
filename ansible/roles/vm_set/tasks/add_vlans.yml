- name: Expand vlan list
  set_fact: vlan_arr={{ vlans.split(',') + ['-1', '-1', '-1', '-1', '-1', '-1', '-1', '-1'] }}

# FIXME: my ansible doesn't support nested loops. So below are copy of everything
- name: Add external interfaces. Vlan 0. vm set {{ id }}
  include: add_vlan.yml
  vars:
    vlan_id: "{{ vlan_arr[0]|int - 1}}"
    port0_bridge: "br-vs{{ id }}-vm{{ num }}-0"
    vlan: "{{ vlan_base|int + vlan_id|int }}"
    vlan_iface: "{{ external_iface }}.{{ vlan_base|int + vlan_id|int }}"
    injected_iface: "inje-{{ id }}-{{ vlan_id }}"
  when: vlan_arr[0] != '-1'

- name: Add external interfaces. Vlan 1. vm set {{ id }}
  include: add_vlan.yml
  vars:
    vlan_id: "{{ vlan_arr[1]|int - 1}}"
    port0_bridge: "br-vs{{ id }}-vm{{ num }}-1"
    vlan: "{{ vlan_base|int + vlan_id|int }}"
    vlan_iface: "{{ external_iface }}.{{ vlan_base|int + vlan_id|int }}"
    injected_iface: "inje-{{ id }}-{{ vlan_id }}"
  when: vlan_arr[1] != '-1'

- name: Add external interfaces. Vlan 2. vm set {{ id }}
  include: add_vlan.yml
  vars:
    vlan_id: "{{ vlan_arr[2]|int - 1}}"
    port0_bridge: "br-vs{{ id }}-vm{{ num }}-2"
    vlan: "{{ vlan_base|int + vlan_id|int }}"
    vlan_iface: "{{ external_iface }}.{{ vlan_base|int + vlan_id|int }}"
    injected_iface: "inje-{{ id }}-{{ vlan_id }}"
  when: vlan_arr[2] != '-1'

- name: Add external interfaces. Vlan 3. vm set {{ id }}
  include: add_vlan.yml
  vars:
    vlan_id: "{{ vlan_arr[3]|int - 1}}"
    port0_bridge: "br-vs{{ id }}-vm{{ num }}-3"
    vlan: "{{ vlan_base|int + vlan_id|int }}"
    vlan_iface: "{{ external_iface }}.{{ vlan_base|int + vlan_id|int }}"
    injected_iface: "inje-{{ id }}-{{ vlan_id }}"
  when: vlan_arr[3] != '-1'

- name: Add external interfaces. Vlan 4. vm set {{ id }}
  include: add_vlan.yml
  vars:
    vlan_id: "{{ vlan_arr[4]|int - 1}}"
    port0_bridge: "br-vs{{ id }}-vm{{ num }}-4"
    vlan: "{{ vlan_base|int + vlan_id|int }}"
    vlan_iface: "{{ external_iface }}.{{ vlan_base|int + vlan_id|int }}"
    injected_iface: "inje-{{ id }}-{{ vlan_id }}"
  when: vlan_arr[4] != '-1'

- name: Add external interfaces. Vlan 5. vm set {{ id }}
  include: add_vlan.yml
  vars:
    vlan_id: "{{ vlan_arr[5]|int - 1}}"
    port0_bridge: "br-vs{{ id }}-vm{{ num }}-5"
    vlan: "{{ vlan_base|int + vlan_id|int }}"
    vlan_iface: "{{ external_iface }}.{{ vlan_base|int + vlan_id|int }}"
    injected_iface: "inje-{{ id }}-{{ vlan_id }}"
  when: vlan_arr[5] != '-1'

- name: Add external interfaces. Vlan 6. vm set {{ id }}
  include: add_vlan.yml
  vars:
    vlan_id: "{{ vlan_arr[6]|int - 1}}"
    port0_bridge: "br-vs{{ id }}-vm{{ num }}-6"
    vlan: "{{ vlan_base|int + vlan_id|int }}"
    vlan_iface: "{{ external_iface }}.{{ vlan_base|int + vlan_id|int }}"
    injected_iface: "inje-{{ id }}-{{ vlan_id }}"
  when: vlan_arr[6] != '-1'

- name: Add external interfaces. Vlan 7. vm set {{ id }}
  include: add_vlan.yml
  vars:
    vlan_id: "{{ vlan_arr[7]|int - 1}}"
    port0_bridge: "br-vs{{ id }}-vm{{ num }}-7"
    vlan: "{{ vlan_base|int + vlan_id|int }}"
    vlan_iface: "{{ external_iface }}.{{ vlan_base|int + vlan_id|int }}"
    injected_iface: "inje-{{ id }}-{{ vlan_id }}"
  when: vlan_arr[7] != '-1'

