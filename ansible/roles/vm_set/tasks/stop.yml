- name: Remove VMs. vm set {{ id }}
  include: stop_vm.yml
  vars:
    vm_name: "{{ id }}_{{ item.key }}"
    disk_image: "{{ root_path }}/disks/{{ vm_name }}_hdd.vmdk"
  with_dict: "{{ VMs }}"

- name: Remove external interfaces. vm set {{ id }}
  include: delete_vlans.yml
  vars:
    num: "{{ item.value.num }}"
  with_dict: "{{ VMs }}"

- name: Remove ptf docker container. vm set {{ id }}
  docker:
    name: ptf_injected_{{ id }}
    image: "{{ docker_registry_host }}/{{ docker_image }}"
    state: absent

# FIXME: my ansible doesn't support nested loops. So below are copy of everything
- name: Remove bridges. vlan 0. vm set {{ id }}
  include: delete_bridge.yml
  vars:
    port0_bridge: "br-vs{{ id }}-vm{{ item.value.num }}-0"
  with_dict: "{{ VMs }}"

- name: Remove bridges. vlan 1. vm set {{ id }}
  include: delete_bridge.yml
  vars:
    port0_bridge: "br-vs{{ id }}-vm{{ item.value.num }}-1"
  with_dict: "{{ VMs }}"

- name: Remove bridges. vlan 2. vm set {{ id }}
  include: delete_bridge.yml
  vars:
    port0_bridge: "br-vs{{ id }}-vm{{ item.value.num }}-2"
  with_dict: "{{ VMs }}"

- name: Remove bridges. vlan 3. vm set {{ id }}
  include: delete_bridge.yml
  vars:
    port0_bridge: "br-vs{{ id }}-vm{{ item.value.num }}-3"
  with_dict: "{{ VMs }}"

- name: Remove bridges. vlan 4. vm set {{ id }}
  include: delete_bridge.yml
  vars:
    port0_bridge: "br-vs{{ id }}-vm{{ item.value.num }}-4"
  with_dict: "{{ VMs }}"

- name: Remove bridges. vlan 5. vm set {{ id }}
  include: delete_bridge.yml
  vars:
    port0_bridge: "br-vs{{ id }}-vm{{ item.value.num }}-5"
  with_dict: "{{ VMs }}"

- name: Remove bridges. vlan 6. vm set {{ id }}
  include: delete_bridge.yml
  vars:
    port0_bridge: "br-vs{{ id }}-vm{{ item.value.num }}-6"
  with_dict: "{{ VMs }}"

- name: Remove bridges. vlan 7. vm set {{ id }}
  include: delete_bridge.yml
  vars:
    port0_bridge: "br-vs{{ id }}-vm{{ item.value.num }}-7"
  with_dict: "{{ VMs }}"

- name: Disable port1 bridge {{ port1_bridge }}. vm set {{ id }}
  command: ifconfig {{ port1_bridge }} down
  when: port1_bridge in ansible_interfaces

- name: Destroy port1 bridge {{ port1_bridge }}. vm set {{ id }}
  command: brctl delbr {{ port1_bridge }}
  when: port1_bridge in ansible_interfaces

