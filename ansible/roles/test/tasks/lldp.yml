# Gather minigraph facts
- name: Gathering minigraph facts about the device
  minigraph_facts:
    host: "{{ inventory_hostname }}"

- name: Print neighbors in minigraph
  debug: msg="{{ minigraph_neighbors }}"

- name: find minigraph lldp neighbor
  set_fact:
    minigraph_lldp_nei:  "{{ minigraph_lldp_nei|default({}) | combine({ item.key : item.value}) }}"
  when: "'server' not in item.value['name'] | lower"
  with_dict: minigraph_neighbors

- name: Gather information from LLDP
  lldp:
  vars:
    ansible_shell_type: docker
    ansible_python_interpreter: docker exec -i lldp python

- name: Print LLDP information
  debug: msg="{{ lldp }}"

- name: Verify LLDP information is available on most interfaces
  assert: { that: "{{ lldp|length }} > {{ minigraph_lldp_nei|length * 0.8 }}"}

- name: Compare the LLDP neighbor name with minigraph neigbhor name (exclude the management port)
  assert: { that: "'{{ lldp[item]['chassis']['name'] }}' == '{{ minigraph_lldp_nei[item]['name'] }}'" }
  with_items: "{{ lldp.keys() }}"
  when: item != "eth0"

- name: Compare the LLDP neighbor interface with minigraph neigbhor interface (exclude the management port)
  assert: { that: "'{{ lldp[item]['port']['ifname'] }}' == '{{ minigraph_neighbors[item]['port'] }}'" }
  with_items: "{{ lldp.keys() }}"
  when: item != "eth0"

- block:
  - name: Obtain the system description of the DUT chassis
    shell: "docker exec -i lldp lldpcli show chassis | grep \"SysDescr:\" | sed -e 's/^\\s*SysDescr:\\s*//g'"
    register: result

  - name: Store system description of the DUT chassis as a fact
    set_fact:
      dut_system_description: "{{ result.stdout }}"

###TODO: fix this lldp_neighbor validation, this part is not running
- name: Iterate through each LLDP neighbor and verify the information received by neighbor is correct
  add_host:
    name: "{{ lldp[item]['chassis']['mgmt-ip'] }}"
    groups: "lldp_neighbors,eos"
    neighbor_interface: "{{ lldp[item]['port']['ifname'] }}"
    dut_interface: "{{ item }}"
    hname: "{{ lldp[item]['chassis']['mgmt-ip'] }}"
    dut_chassis_id: "0x{{ ansible_eth0['macaddress'] | replace(':', '') }}"
    dut_hostname: "{{ inventory_hostname }}"
    dut_port_alias: "{{ minigraph_ports[item]['alias'] }}"
    dut_port_description: "{{ minigraph_neighbors[item]['name'] }}:{{ minigraph_neighbors[item]['port'] }}"
    dut_system_description: "{{ dut_system_description }}"
  with_items: "{{ lldp.keys() }}"
  when: item != "eth0"

################Test Cases for LLDP bug fixes #######################
- block:
    - debug: msg="Deployment Specific Test Cases, Test LLDP timing/buffer issue."

    # create the config_db.json (test specific)
    - name: collect SONiC current configuration info (to find macaddress)
      setup:

    - name: saved original config_db.json in SONiC DUT (ignore errors when file does not exist)
      shell: cp /etc/sonic/config_db.json /etc/sonic/config_db.json.orig
      become: true
      ignore_errors: true

    - name: copy test specific lldp_config_db.json to Sonic DUT
      become: true
      copy:
        src: roles/test/files/test_specific_configs/lldp_config_db.json
        dest: /etc/sonic/config_db.json

    - name: update mac hostname and speed in config_db.json
      become: true
      replace:
        dest: /etc/sonic/config_db.json
        regexp: "{{ item.regexp}}"
        replace: "{{ item.line }}"
      with_items:
        - { regexp: '"hostname": ".*"', line: '"hostname": "{{ testbed_facts["dut"] }}"' }

    - name: execute cli "config reload -l -y" to merge the system info on device
      become: true
      shell: config reload -l -y

    - name: wait 60 seconds for completion of "config reload" command.
      pause: seconds=60

    - name: Ensure LLDP Daemon is runing and Enabled
      become: true
      service: name=lldpd
               state=running
               enabled=yes
      vars:
        ansible_shell_type: docker
        ansible_python_interpreter: docker exec -i lldp python

    - name: Get total number of interfaces from config_db.json file
      shell: sonic-cfggen -j /etc/sonic/config_db.json -v "PORT.keys() | length"
      register: interface_num

    - name: Restart swss service and check lldpcli show statistics 10 times in a loop
      shell: |
         service swss restart & sleep 15s
         docker exec -it lldp bash -c "lldpcli show statistics | grep Ethernet | wc -l"
      register: lldpcli_output
      failed_when: lldpcli_output.stdout != interface_num.stdout
      with_sequence: start=0 end=10 stride=1

  always:
    - name: Restore the original config_db.json
      shell: mv /etc/sonic/config_db.json.orig /etc/sonic/config_db.json
      become: true
      ignore_errors: true

    - name: execute cli "config reload -y" to apply restored config_db.json
      become: true
      shell: config reload -y

    - name: reboot
      include: common_tasks/reboot_sonic.yml

    - name: validate all interfaces are up after test
      include: interface.yml

    - name: wait for interfaces to come up
      interface_facts: up_ports={{minigraph_ports}}
      until: "{{ ansible_interface_link_down_ports | length }} == 0"
      retries: 10
      delay: 15
## End of Test Cases for LLDP bug fixes ###
