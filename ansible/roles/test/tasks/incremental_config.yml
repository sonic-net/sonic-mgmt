- debug: msg="Tests for the incremental configuration features of the cli"

- name: gather interface facts
  interface_facts:

- name: set initial variables
  set_fact:
    test_ipv4_address: 10.200.4.5/24
    test_ipv6_address: fc00::aa07/126
    test_port_channel_name: PortChannel0999
    test_vlan: 999

- name: Get a list of active Ethernet interface names
  set_fact:
    test_interfaces: "{{ test_interfaces|default([]) }} + ['{{ item.device }}']"
  when: item.active == True and "Ethernet" in item.device
  with_items: "{{ ansible_interface_facts.values() }}"

- name: verify that there are at least 2 interfaces that we can test with
  assert:
    that: (test_interfaces | length) >= 2
    msg: This test requires at least two active Ethernet interfaces

- name: Add and remove an IPv4 address from an interface
  include: incremental_config/incremental_config_ip.yml
  vars:
    ip_type: 'ipv4'
    address: "{{ test_ipv4_address }}"
    interface: "{{ test_interfaces[0] }}"

- name: Add and remove an IPv6 address from an interface
  include: incremental_config/incremental_config_ip.yml
  vars:
    ip_type: 'ipv6'
    address: "{{ test_ipv6_address }}"
    interface: "{{ test_interfaces[0] }}"

- name: Add and remove VLAN membership from an interface
  include: incremental_config/incremental_config_vlan.yml
  vars:
    interface: "{{ test_interfaces[0] }}"

- name: Add and remove a portchannel interface
  include: incremental_config/incremental_config_portchannel.yml
  vars:
    name: "{{ test_port_channel_name }}"
    members: "{{ test_interfaces[:2] }}"

- name: Add and remove some acl rules via the incremental updated command
  include: incremental_config/incremental_config_acl_incremental_update.yml

- name: Do basic sanity check and allow recovery
  include: base_sanity.yml
  vars:
    recover: "{{ allow_recover }}"

- name: Validate all interfaces are up and allow recovery
  include: interface.yml
  vars:
    recover: "{{ allow_recover }}"
