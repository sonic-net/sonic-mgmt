- debug: msg="Starting port channel incremental config test"

- name: set initial variables for portchannel test
  set_fact:
    ethernet_portchannel_interfaces: []
    

# Add a portchannel
- block:
    - name: add a port channel 
      shell: config portchannel add {{ name }} 
      become: yes
    
    - name: pull current portchannel status 
      shell: show interfaces portchannel 
      register: out

    - name: verify that the portchannel shows up in the output 
      assert:
        that: out.stdout | search(name)

    - name: add members to the portchannel
      shell: config portchannel member add {{ name }} {{ item }}
      become: yes
      with_items: "{{ members }}"

    - name: pull current portchannel status 
      shell: show interfaces portchannel
      register: out
    
    - name: verify that the members show up in the output 
      assert:
        that: out.stdout | search(item)
      with_items: members 

    - name: pull out lines from output for the portchannel ports
      set_fact:
        ethernet_portchannel_interfaces: "{{ ethernet_portchannel_interfaces }} + ['{{ item }}']"
      when: "{{ item | search(name) }}"
      with_items: "{{ out.stdout_lines }}"
  
    - name: check the condensed list and confirm each port channel member is in the list
      assert:
        that: ethernet_portchannel_interfaces | select('match', item)
      with_items: "{{ members }}"

    - name: remove the members from the port channel
      shell: config portchannel member del {{ name }} {{ item }}
      become: yes
      with_items: "{{ members }}"

    - name: verify the ports have been removed
      shell: show interfaces portchannel
      register: out

    - name: verify the portchannel name no longer shows up in the output
      assert:
        that: item not in out.stdout
      with_items: members

    - name: remove the portchannel
      shell: config portchannel del {{ name }} 
      become: yes
    
    - name: verify the portchannel has been removed
      shell: show interfaces portchannel 
      register: out

    - name: verify that the portchannel is not configured
      assert:
        that: not out.stdout | search( name )

  rescue:
    - name: pull output from switch
      shell: show interface portchannel
      register: out

    - name: remove portchannel members on failure
      shell: config portchannel member del {{ name }} {{ item }}
      become: yes
      with_items: "{{ members }}"
      when: item in out.stdout

    - name: remove the portchannel on failure
      shell: config portchannel del {{ name }} 
      become: yes
      when: name in out.stdout
