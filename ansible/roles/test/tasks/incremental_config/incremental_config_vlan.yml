# Test the CLI commands to add/remove VLAN membership from an interface
- debug: msg="Starting vlan incremental config test"

- block:
    - name: add vlan
      shell: config vlan add {{ test_vlan }}
      become: yes
    
    - name: confirm vlan was added 
      shell: show vlan brief 
      register: out
      failed_when: not out.stdout | search(test_vlan | string)

    - name: Make the test interface a member of the VLAN
      shell: config vlan member add {{ test_vlan }} {{ interface }}
      become: yes

    - name: Verify that the test interface is a member of the VLAN
      shell: show vlan config | grep Vlan{{ test_vlan }}
      register: out
      failed_when: not out.stdout | search(interface)

    - name: Remove the VLAN membership from the test interface
      shell: config vlan member del {{ test_vlan }} {{ interface }}
      become: yes

    - name: Verify that the test interface is not a member of the VLAN
      shell: show vlan config | grep Vlan{{ test_vlan }}
      register: out
      failed_when: out.stdout | search(interface)

    - name: Remove the VLAN
      shell: config vlan del {{ test_vlan }}
      become: yes
    
    - name: Confirm that the VLAN was deleted
      shell: show vlan brief 
      register: out
      failed_when: out.stdout | search(test_vlan | string)

  rescue:
    - name: Remove the VLAN
      shell: config vlan del {{ test_vlan }}
      become: yes
