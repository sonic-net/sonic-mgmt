- set_fact:
    run_dir: /home/admin/everflow_tests
    out_dir: /home/admin/everflow_tests/results
    docker_testdir: /tmp
    tests_location: roles/test/tasks/everflow_testbed
    testname: del_config

- name: Get session info
  include: roles/test/tasks/everflow_testbed/get_session_info.yml

- name: Copy python script for session configuration
  copy: src=roles/test/files/helpers/mirror_session.py dest={{ run_dir }}/
  become: yes

- name: Copy data plane ACL rules configuration file
  copy: src=roles/test/tasks/acl/acltb_test_rules-del.json dest={{ run_dir }}/
  become: yes

- name: Copy EVERFLOW ACL rules configuration file
  copy: src={{ tests_location }}/{{ testname}}/acl_rule_persistent-del.json dest={{ run_dir }}/
  become: yes

- name: Remove EVERFLOW ACL rules
  command: "acl-loader update full {{ run_dir }}/acl_rule_persistent-del.json --table_name=EVERFLOW"
  become: yes

- name: Remove EVERFLOW mirror session
  command: "python {{ run_dir }}/mirror_session.py delete {{ session_name }}"

- name: Get number of data plane ACL rules after applying EVERFLOW ACL rules
  command: "bash -c 'acl-loader show rule | grep DATAACL | wc -l'"
  register: acl_loader_output

- name: Assert there are 14 data plane ACL rules
  assert: { that: "{{'14' in acl_loader_output.stdout_lines}}" }

- name: Remove dataplane ACL rules
  command: "acl-loader update full {{ run_dir }}/acltb_test_rules-del.json"
  become: yes
