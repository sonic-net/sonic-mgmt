# Set facts for the loganalizer
- set_fact:
    out_dir: /tmp/loganalizer
    testname: acl
    run_dir: /tmp/
    tests_location: "roles/test/tasks"
    test_match_file: "acltb_match_messages.txt"
    test_ignore_file: "acltb_ignore_messages.txt"
    test_expect_file: "acltb_expect_messages.txt"

- name: Check supported topology
  fail: msg="Invalid testbed_type value '{{testbed_type}}'"
  when: testbed_type not in ['t1', 't1-lag', 't1-64-lag']

- block:
    - name: Prepare variables for ACL configuration
      set_fact:
        dut_tmp_dir: "/home/admin/acl"
        config_db_backup_filename: /etc/sonic/config_db.json.bak.{{ lookup('pipe','date +%Y%m%d-%H%M%S') }}

    - name: Backup config_db.json
      command: cp /etc/sonic/config_db.json {{ config_db_backup_filename }}
      become: yes

    - include: "roles/test/tasks/acl/acltb_config.yml"

    - name: Test ingress ACL
      include: "roles/test/tasks/acl/acltb_run_test.yml"
      vars:
        acl_stage: ingress

    - name: Test egress ACL
      include: "roles/test/tasks/acl/acltb_run_test.yml"
      vars:
        acl_stage: egress
      when: support_egress_acl is defined and support_egress_acl|bool == true

  always:

    - name: Check existence of config_db.json backup file
      stat:
        path: "{{ config_db_backup_filename }}"
      register: config_db_backup_file

    - name: Recover config_db.json from backup
      command: mv {{ config_db_backup_filename }} /etc/sonic/config_db.json
      become: yes
      when: config_db_backup_file.stat.exists

    - name: Reload config to cleanup
      command: config reload -y
      become: yes

    - name: wait 60 seconds for ports to be up
      pause: seconds=60

    - name: Wait for ports to be up
      interface_facts: up_ports={{ all_ports }}
      until: ansible_interface_link_down_ports | length == 0
      retries: 10
      delay: 20

    - name: wait 60 seconds for processes and interfaces to be stable
      pause: seconds=60
