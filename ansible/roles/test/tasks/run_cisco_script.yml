#---------------------------------
# This script runs script for Cisco cli on remote host:
#   1) Reads terminal length value.
#   2) Sets terminal length to 0.
#   2) Runs script.
#   3) Sets terminal value to default.
#
# @ params: template    -   j2-file that contains cli commands
# @ params: host        -   remote host, where to run the script
# @ params: log_in      -   credentials to host
#---------------------------------

- name: Get terminal characteristics.
  action: apswitch template=roles/vm_set/templates/get_terminal_length.j2
  connection: switch
  args:
    host: "{{ host }}"
    enable: yes
    login: "{{ log_in }}"
    timeout: 300
  register: cisco_script_res

- name: Get terminal length default.
  shell: echo {{ cisco_script_res }} | sed -n "s/.*Length. //p" | sed -n "s/ rows.*//p"
  register: terminal_length

- name: Disable terminal paging.
  action: apswitch template=roles/vm_set/templates/set_terminal_length.j2
  connection: switch
  args:
    host: "{{ host }}"
    enable: yes
    login: "{{ log_in }}"
    timeout: 300
  vars:
    terminal_length_value: '0'

- name: Run cisco script on {{ host }} host.
  action: apswitch template={{ template }}
  connection: switch
  args:
    host: "{{ host }}"
    enable: yes
    login: "{{ log_in }}"
    timeout: 300
  register: cisco_script_res

- name: Set terminal length back to default.
  action: apswitch template=roles/vm_set/templates/set_terminal_length.j2
  connection: switch
  args:
    host: "{{ host }}"
    enable: yes
    login: "{{ log_in }}"
    timeout: 300
  vars:
    terminal_length_value: "{{ terminal_length.stdout }}"
