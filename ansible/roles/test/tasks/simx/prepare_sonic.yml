- name: "Set default action (topo_action=add) if no arguments provided"
  set_fact:
    topo_action: "add"
  when: "topo_action is not defined"

- fail: msg="topo_action is provided with invalid value"
  when: "topo_action not in [ 'add', 'remove' ]"

- name: "Set zebra template config facts"
  set_fact:
    zebra_orig_config: "/usr/share/sonic/templates/zebra.conf.j2_orig"
    zebra_simx_config: "/usr/share/sonic/templates/zebra.conf.j2_simx"
    zebra_config: "/usr/share/sonic/templates/zebra.conf.j2"

- block:
  - name: "Gathering minigraph facts about the device"
    minigraph_facts: host={{ inventory_hostname }}

  - name: "Set T1 topology"
    set_fact:
      testbed_type: "t1"

  - name: "Include T1 topology variables"
    include_vars: "vars/topo_t1.yml"

  - name: "Expand properties into props"
    set_fact:
      props: "{{ configuration_properties['spine'] }}"
      props_tor: "{{ configuration_properties['tor'] }}"

  - name: "Generate route-port map information"
    template:
      src: "roles/test/templates/fib.j2"
      dest: "/tmp/fib_info.txt"
    connection: "local"

  - name: "Generate FIB facts"
    fib_facts:
      fib: "/tmp/fib_info.txt"
    connection: "local"

  - name: "Generate zebra config"
    template:
      src: "roles/test/templates/simx/zebra_route_populate.conf.j2"
      dest: "/tmp/zebra_route_populate.conf"

  - name: "Check for backuped original zebra template config"
    shell: "docker exec bgp bash -c '[ -f {{ zebra_orig_config }} ] && echo 'yes' || echo 'no''"
    register: "stat_result"

  - name: "Restore original zebra template config if backup exists"
    shell: "docker exec bgp bash -c 'cp -f {{ zebra_orig_config }} {{ zebra_config }}'"
    when: "stat_result.stdout == 'yes'"

  - name: "Create original zebra template config backup if it doesn't exist"
    shell: "docker exec bgp bash -c 'cp -f {{ zebra_config }} {{ zebra_orig_config }}'"
    when: "stat_result.stdout == 'no'"

  - name: "Copy zebra config to BGP container"
    shell: "docker cp /tmp/zebra_route_populate.conf bgp:/zebra_route_populate.conf"

  - name: "Append to existing zebra template config"
    shell: "docker exec bgp bash -c 'cat /zebra_route_populate.conf >> {{ zebra_config }}'"

  - name: "Clean up intermediate zebra config"
    shell: "docker exec bgp bash -c 'rm -f /zebra_route_populate.conf'"

  - name: "Check for backuped SimX zebra template config"
    shell: "docker exec bgp bash -c '[ -f {{ zebra_simx_config }} ] && echo 'yes' || echo 'no''"
    register: "stat_result"

  - name: "Create SimX zebra template config backup if it doesn't exist"
    shell: "docker exec bgp bash -c 'cp -f {{ zebra_config }} {{ zebra_simx_config }}'"
    when: "stat_result.stdout == 'no'"

  when: "topo_action is defined and topo_action == 'add'"

- block:
  - name: "Check for backuped original zebra template config"
    shell: "docker exec bgp bash -c '[ -f {{ zebra_orig_config }} ] && echo 'yes' || echo 'no''"
    register: "stat_result"

  - name: "Restore original zebra template config if backup exists"
    shell: "docker exec bgp bash -c 'cp -f {{ zebra_orig_config }} {{ zebra_config }}'"
    when: "stat_result.stdout == 'yes'"

  - name: "Clean up backuped zebra template config"
    shell: "{{ item }}"
    with_items:
      - "docker exec bgp bash -c 'rm -f {{ zebra_orig_config }}'"
      - "docker exec bgp bash -c 'rm -f {{ zebra_simx_config }}'"

  when: "topo_action is defined and topo_action == 'remove'"

- name: "Restart BGP docker"
  service:
    name: "bgp"
    state: "restarted"
  become: "yes"

- name: "Wait for 1 minute for BGP to be stable"
  pause: minutes=1
