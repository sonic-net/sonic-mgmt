- debug: msg="{{ device_info[inventory_hostname] }}"

- name: prepare fanout switch admin login info
  set_fact: ansible_ssh_user={{ fanout_sonic_user }} ansible_ssh_password={{ fanout_sonic_password }}

- name: get fanout switch hwsku
  set_fact: fanout_hwsku="{{ device_info[inventory_hostname]["HwSku"] }}"

- name: check if fanout hwsku is supported
  fail: msg="SONiC fanout switch with HwSku {{ device_info[inventory_hostname]['HwSku'] }} not supported"
  when:
    - fanout_hwsku != "Arista-7060CX-32S-C32"
    - fanout_hwsku != "DellEMC-Z9332f-M-O16C64"
    - fanout_hwsku != "DellEMC-Z9332f-O32"

- name: find interface name mapping
  port_alias: hwsku="{{ fanout_hwsku }}"

- name: build fanout startup config for Arista 7060 SONiC leaf fanout
  template: src=sonic_deploy_arista_7060.j2
            dest=/etc/sonic/vlan.json
  when: fanout_hwsku == "Arista-7060CX-32S-C32"
  become: yes

- name: build fanout startup config for Dell 9332 SONiC leaf fanout
  template: src=sonic_deploy.j2
            dest=/etc/sonic/vlan.json
  when: fanout_hwsku == "DellEMC-Z9332f-M-O16C64" or fanout_hwsku == "DellEMC-Z9332f-O32"

- name: disable all copp rules for 201911 and earlier
  shell:
    cmd: docker exec swss bash -c 'echo [] > /etc/swss/config.d/00-copp.config.json'
  become: yes

- name: disable all copp rules for 202012 and later
  shell:
    cmd: echo {} > /etc/sonic/copp_cfg.json
  become: yes

- name: generate config_db.json
  shell: sonic-cfggen -H -j /etc/sonic/vlan.json --print-data > /etc/sonic/config_db.json
  become: yes

- name: reload running config
  shell: config reload -y
  become: yes

- name: detach all fp entries for brcm-based fanouts
  shell:
    cmd: bcmcmd "fp detach" && bcmcmd "fp init"
  become: yes
  when: fanout_hwsku == "DellEMC-Z9332f-M-O16C64" or fanout_hwsku == "DellEMC-Z9332f-O32" or fanout_hwsku == "Arista-7060CX-32S-C32"

- name: stop and disable lldp service
  service: name=lldp state=stopped enabled=no
  become: yes

- name: stop and disable dhcp_relay service
  service: name=dhcp_relay state=stopped enabled=no
  become: yes

- name: stop and disable bgp service
  service: name=bgp state=stopped enabled=no
  become: yes

- name: stop and disable teamd service
  service: name=teamd state=stopped enabled=no
  become: yes
