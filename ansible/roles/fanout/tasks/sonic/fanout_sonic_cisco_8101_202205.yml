- fail: msg="Cisco fanout do not support sonic version other than 20220531.45"
  when: "'20220531.45' not in fanout_sonic_version['build_version']"

- name: collect fanout port config
  port_config_gen:
    hwsku: "{{ device_info[inventory_hostname]['HwSku'] }}"
    hwsku_type: "{{ device_info[inventory_hostname]['HwSkuType'] | default('predefined') }}"
    device_conn: "{{ device_conn[inventory_hostname] }}"
  become: yes

- name: build fanout startup config
  template:
    src: "sonic_deploy_cisco_8101_202205.j2"
    dest: "/tmp/base_config.json"

- name: build fanout cisco 8101 C64 config
  copy:
    src: "cisco_8101_c64.json"
    dest: "/tmp/cisco_8101_config.json"
  when: "'Cisco-8101-C64' in device_info[inventory_hostname]['HwSku']"

- name: build fanout cisco 8101 O8C48 config
  copy:
    src: "roles/fanout/templates/cisco_8101_o8c48.json"
    dest: "/tmp/cisco_8101_config.json"
  when: "'Cisco-8101-O8C48' in device_info[inventory_hostname]['HwSku']"

- name: build fanout cisco 8101 O32 config
  copy:
    src: "cisco_8101_o32.json"
    dest: "/tmp/cisco_8101_config.json"
  when: "'Cisco-8101-O32' in device_info[inventory_hostname]['HwSku']"

- name: merge cisco 8101 fanout startup config
  shell: jq -s '.[0] * .[1]' /tmp/base_config.json /tmp/cisco_8101_config.json > /tmp/merged_config.json && mv /tmp/merged_config.json /tmp/base_config.json

- name: generate config_db.json
  shell: sonic-cfggen -H -j /tmp/base_config.json --print-data > /etc/sonic/config_db.json
  become: yes

- name: copy Cisco 8101 fanout command file to fanout
  copy:
    src: "templates/cisco_8101_commands.txt"
    dest: "/tmp/cisco_8101_commands.txt"

- name: Disable feature teamd and remove teamd container (avoid swss crash after config reload)
  block:
    - name: Check if teamd container exists
      shell: "docker ps -a -q -f name=teamd"
      register: teamd_container

    - name: disable feature teamd and remove container
      block:
        - name: disable feature teamd
          shell: config feature state teamd disabled
          become: true
        - name: ensure teamd container is stopped
          docker_container:
            name: teamd
            state: stopped
          become: true
          ignore_errors: yes
        - name: remove teamd container
          docker_container:
            name: teamd
            state: absent
          become: true
      when: teamd_container.stdout != ""

- name: SONiC update config db
  shell: config reload -y -f
  become: true

- name: wait for SONiC update config db finish
  pause:
    seconds: 180

- name: Shutdown arp_update process in swss (avoid fanout broadcasting it's MAC address)
  shell: docker exec -i swss supervisorctl stop arp_update
  become: yes

- name: Disable LLDP on Cisco 8101 fanout
  shell: |
    config feature autorestart lldp disabled
    config feature state lldp disabled
    docker exec -i syncd supervisorctl start dshell_client
  become: yes

- name: wait for dshell_client start
  pause:
    seconds: 300

- name: Clear L2 trap configuration on Cisco 8101 fanout
  shell: cat /tmp/cisco_8101_commands.txt | docker exec -i syncd sh -c "/usr/bin/dshell_client.py -i"
