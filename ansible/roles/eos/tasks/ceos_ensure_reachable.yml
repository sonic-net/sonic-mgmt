- block:
  - name: set time out threshold
    set_fact:
      timeout_threshold: 120
    
  - name: wait for container's mgmt-ip reachable
    wait_for:
      port: 22
      host: "{{ ansible_host }}"
      state: started
      delay: 0
      timeout: "{{ timeout_threshold }}"
    register: ceos_reachability
    ignore_errors: yes
    delegate_to: "localhost"

  - name: restart cEOS container
    become: yes
    docker_container:
      name: ceos_{{ vm_set_name }}_{{ inventory_hostname }}
      restart: yes
    when: ceos_reachability.failed and ceos_reachability.elapsed >= timeout_threshold
    delegate_to: "{{ VM_host[0] }}"

  - name: update container_reachable
    set_fact:
      container_reachable: "{{ not ceos_reachability.failed|bool }}"

  when: not container_reachable
