<DeviceMiniGraph xmlns="Microsoft.Search.Autopilot.Evolution" xmlns:i="http://www.w3.org/2001/XMLSchema-instance">
  <CpgDec>
    <IsisRouters xmlns:a="http://schemas.datacontract.org/2004/07/Microsoft.Search.Autopilot.Evolution"/>
    <PeeringSessions>
{% set vms=vm_topo_config['vm'].keys() | sort %}
{% set vms_number = vms | length %}
{% for index in range(vms_number) %}
{% set vm=vms[index] %}
{% if vm_topo_config['vm'][vm]['peer_ipv4'] %}
      <BGPSession>
        <MacSec>false</MacSec>
        <StartRouter>{{ inventory_hostname }}</StartRouter>
        <StartPeer>{{ vm_topo_config['vm'][vm]['bgp_ipv4'] }}</StartPeer>
        <EndRouter>{{ vm }}</EndRouter>
        <EndPeer>{{ vm_topo_config['vm'][vm]['peer_ipv4'] }}</EndPeer>
        <Multihop>1</Multihop>
        <HoldTime>10</HoldTime>
        <KeepAliveTime>3</KeepAliveTime>
      </BGPSession>
{% endif %}
{% if vm_topo_config['vm'][vm]['peer_ipv6'] %}
      <BGPSession>
        <StartRouter>{{ inventory_hostname }}</StartRouter>
        <StartPeer>{{ vm_topo_config['vm'][vm]['bgp_ipv6'] }}</StartPeer>
        <EndRouter>{{ vm }}</EndRouter>
        <EndPeer>{{ vm_topo_config['vm'][vm]['peer_ipv6'] }}</EndPeer>
        <Multihop>1</Multihop>
        <HoldTime>10</HoldTime>
        <KeepAliveTime>3</KeepAliveTime>
      </BGPSession>
{% endif %}
{% endfor %}
    </PeeringSessions>
    <Routers xmlns:a="http://schemas.datacontract.org/2004/07/Microsoft.Search.Autopilot.Evolution">
      <a:BGPRouterDeclaration>
        <a:ASN>{{ vm_topo_config['dut_asn'] }}</a:ASN>
        <a:Hostname>{{ inventory_hostname }}</a:Hostname>
        <a:Peers>
{% for index in range(vms_number)  %}
          <BGPPeer>
            <Address>{{ vm_topo_config['vm'][vms[index]]['peer_ipv4'] }}</Address>
            <RouteMapIn i:nil="true"/>
            <RouteMapOut i:nil="true"/>
            <Vrf i:nil="true"/>
          </BGPPeer>
{% endfor %}
{% if 'tor' in vm_topo_config['dut_type'] | lower %}
          <BGPPeer i:type="a:BGPPeerPassive">
            <ElementType>BGPPeer</ElementType>
            <Address>10.1.0.32</Address>
            <RouteMapIn i:nil="true"/>
            <RouteMapOut i:nil="true"/>
            <Vrf i:nil="true"/>
            <a:Name>BGPSLBPassive</a:Name>
            <a:PeersRange>10.255.0.0/25</a:PeersRange>
          </BGPPeer>
          <BGPPeer i:type="a:BGPPeerPassive">
            <ElementType>BGPPeer</ElementType>
            <Address>10.1.0.32</Address>
            <RouteMapIn i:nil="true"/>
            <RouteMapOut i:nil="true"/>
            <Vrf i:nil="true"/>
            <a:Name>BGPVac</a:Name>
            <a:PeersRange>192.168.0.0/25</a:PeersRange>
          </BGPPeer>
{% endif %}
        </a:Peers>
        <a:RouteMaps/>
      </a:BGPRouterDeclaration>
{% for index in range( vms_number) %}
      <a:BGPRouterDeclaration>
        <a:ASN>{{ vm_topo_config['vm'][vms[index]]['bgp_asn'] }}</a:ASN>
        <a:Hostname>{{ vms[index] }}</a:Hostname>
        <a:RouteMaps/>
      </a:BGPRouterDeclaration>
{% endfor %}
    </Routers>
  </CpgDec>
  <DpgDec>
    <DeviceDataPlaneInfo>
      <IPSecTunnels/>
      <LoopbackIPInterfaces xmlns:a="http://schemas.datacontract.org/2004/07/Microsoft.Search.Autopilot.Evolution">
        <a:LoopbackIPInterface>
          <Name>HostIP</Name>
          <AttachTo>Loopback0</AttachTo>
          <a:Prefix xmlns:b="Microsoft.Search.Autopilot.Evolution">
            <b:IPPrefix>10.1.0.32/32</b:IPPrefix>
          </a:Prefix>
          <a:PrefixStr>10.1.0.32/32</a:PrefixStr>
        </a:LoopbackIPInterface>
        <a:LoopbackIPInterface>
          <Name>HostIP1</Name>
          <AttachTo>Loopback0</AttachTo>
          <a:Prefix xmlns:b="Microsoft.Search.Autopilot.Evolution">
            <b:IPPrefix>FC00:1::32/128</b:IPPrefix>
          </a:Prefix>
          <a:PrefixStr>FC00:1::32/128</a:PrefixStr>
        </a:LoopbackIPInterface>
      </LoopbackIPInterfaces>
      <ManagementIPInterfaces xmlns:a="http://schemas.datacontract.org/2004/07/Microsoft.Search.Autopilot.Evolution">
        <a:ManagementIPInterface>
          <Name>HostIP</Name>
          <AttachTo>eth0</AttachTo>
          <a:Prefix xmlns:b="Microsoft.Search.Autopilot.Evolution">
            <b:IPPrefix>{{ ansible_host }}/{{ mgmt_subnet_mask_length }}</b:IPPrefix>
          </a:Prefix>
          <a:PrefixStr>{{ ansible_host }}/{{ mgmt_subnet_mask_length }}</a:PrefixStr>
        </a:ManagementIPInterface>
        <a:ManagementIPInterface>
          <Name>V6HostIP</Name>
          <AttachTo>eth0</AttachTo>
          <a:Prefix xmlns:b="Microsoft.Search.Autopilot.Evolution">
            <b:IPPrefix>FC00:2::32/64</b:IPPrefix>
          </a:Prefix>
          <a:PrefixStr>FC00:2::32/64</a:PrefixStr>
        </a:ManagementIPInterface>
      </ManagementIPInterfaces>
      <ManagementVIPInterfaces xmlns:a="http://schemas.datacontract.org/2004/07/Microsoft.Search.Autopilot.Evolution"/>
      <MplsInterfaces/>
      <MplsTeInterfaces/>
      <RsvpInterfaces/>
      <Hostname>{{ inventory_hostname }}</Hostname>
      <PortChannelInterfaces>
{% for index in range(vms_number) %}
{% if 'port-channel' in vm_topo_config['vm'][vms[index]]['ip_intf']|lower %}
{% set port_channel_intf=';'.join(intf_names[vms[index]])  %}
        <PortChannel>
          <Name>PortChannel{{ ((index+1)|string).zfill(4) }}</Name>
          <AttachTo>{{ port_channel_intf }}</AttachTo>
          <SubInterface/>
        </PortChannel>
{% endif %}
{% endfor %}
      </PortChannelInterfaces>
      <VlanInterfaces>
{% if 'tor' in vm_topo_config['dut_type'] | lower %}
{% set vlan_intf_str=';'.join(vlan_intfs) %}
        <VlanInterface>
          <Name>Vlan1000</Name>
           <AttachTo>{{ vlan_intf_str }}</AttachTo>          
          <NoDhcpRelay>False</NoDhcpRelay>
          <StaticDHCPRelay>0.0.0.0/0</StaticDHCPRelay>
          <Type i:nil="true"/>
{% set dhcp_servers_str=';'.join(dhcp_servers) %}
          <DhcpRelays>{{ dhcp_servers_str }}</DhcpRelays>
          <VlanID>1000</VlanID>
          <Tag>1000</Tag>
          <Subnets>192.168.0.0/21</Subnets>
        </VlanInterface>
{% endif %}
      </VlanInterfaces>
      <IPInterfaces>
{% for index in range(vms_number) %}
        <IPInterface>
          <Name i:nil="true"/>
{% if 'port-channel' in vm_topo_config['vm'][vms[index]]['ip_intf']|lower %}
          <AttachTo>PortChannel{{ ((index+1) |string).zfill(4) }}</AttachTo>
{% else %}
          <AttachTo>{{ port_alias[vm_topo_config['vm'][vms[index]]['interface_indexes'][0]] }}</AttachTo>
{% endif %}
          <Prefix>{{ vm_topo_config['vm'][vms[index]]['bgp_ipv4'] }}/{{ vm_topo_config['vm'][vms[index]]['ipv4mask'] }}</Prefix>
        </IPInterface>
        <IPInterface>
          <Name i:Name="true"/>
{% if 'port-channel' in (vm_topo_config['vm'][vms[index]]['ip_intf']|lower) %}
          <AttachTo>PortChannel{{ ((index+1) |string).zfill(4) }}</AttachTo>
{% else %}
          <AttachTo>{{ port_alias[vm_topo_config['vm'][vms[index]]['interface_indexes'][0]] }}</AttachTo>
{% endif %}
          <Prefix>{{ vm_topo_config['vm'][vms[index]]['bgp_ipv6'] }}/{{ vm_topo_config['vm'][vms[index]]['ipv6mask'] }}</Prefix>
        </IPInterface>
{% endfor %}
{% if 'tor' in vm_topo_config['dut_type'] | lower %}
        <IPInterface>
          <Name i:nil="true"/>
          <AttachTo>Vlan1000</AttachTo>
          <Prefix>192.168.0.1/27</Prefix>
        </IPInterface>
{% endif %}
      </IPInterfaces>
      <DataAcls/>
      <AclInterfaces>
        <AclInterface>
          <InAcl>SNMP_ACL</InAcl>
          <AttachTo>SNMP</AttachTo>
          <Type>SNMP</Type>
       </AclInterface>
       <AclInterface>
          <AttachTo>ERSPAN</AttachTo>
          <InAcl>Everflow</InAcl>
          <Type>Everflow</Type>
        </AclInterface>
          <AclInterface>
          <AttachTo>VTY_LINE</AttachTo>
          <InAcl>ssh-only</InAcl>
          <Type>SSH</Type>
        </AclInterface>
      </AclInterfaces>
      <DownstreamSummaries/>
      <DownstreamSummarySet xmlns:a="http://schemas.datacontract.org/2004/07/Microsoft.Search.Autopilot.Evolution"/>
    </DeviceDataPlaneInfo>
  </DpgDec>
  <PngDec>
    <DeviceInterfaceLinks>
{% for index in range(vms_number) %}
{% set vm_intfs=vm_topo_config['vm'][vms[index]]['intfs']|sort %}
{% set dut_intfs=vm_topo_config['vm'][vms[index]]['interface_indexes']|sort %}
{% for if_index in range(vm_intfs | length) %}
      <DeviceLinkBase>
        <ElementType>DeviceInterfaceLink</ElementType>
        <EndDevice>{{ vms[index] }}</EndDevice>
        <EndPort>{{ vm_intfs[if_index] }}</EndPort>
        <StartDevice>{{ inventory_hostname }}</StartDevice>
        <StartPort>{{ port_alias[dut_intfs[if_index]] }}</StartPort>
      </DeviceLinkBase>
{% endfor %}
{% endfor %}
    </DeviceInterfaceLinks>
    <Devices>
      <Device i:type="{{ vm_topo_config['dut_type'] }}">
        <Hostname>{{ inventory_hostname }}</Hostname>
        <HwSku>{{ hwsku }}</HwSku>
        <ManagementAddress xmlns:a="Microsoft.Search.Autopilot.NetMux">
           <a:IPPrefix>{{ ansible_host }}</a:IPPrefix>
        </ManagementAddress>
      </Device>
{% if VM_topo   %}
{% for dev in neighbor_eosvm_mgmt %}
{% if 'T1' in dev %}
{% set dev_type = 'LeafRouter' %}
{% elif 'T2' in dev %}
{% set dev_type = 'SpineRouter' %}
{% elif 'T0' in dev %}
{% set dev_type = 'TorRouter' %}
{% else %}
{% set dev_ytpe = 'Unknown' %}
{% endif %}
      <Device i:type="{{ dev_type }}">
         <Hostname>{{ dev }}</Hostname>
         <ManagementAddress xmlns:a="Microsoft.Search.Autopilot.NetMux">
           <a:IPPrefix>{{ neighbor_eosvm_mgmt[dev] }}</a:IPPrefix>
         </ManagementAddress>
         <HwSku>Arista-VM</HwSku>
       </Device>
{% endfor %}
{% endif %}
    </Devices>
  </PngDec>
  <DeviceInfos>
    <DeviceInfo>
      <AutoNegotiation>true</AutoNegotiation>
      <EthernetInterfaces xmlns:a="http://schemas.datacontract.org/2004/07/Microsoft.Search.Autopilot.Evolution">
{% set num_of_intf = port_alias | length %}
{% for index in range(num_of_intf) %}
        <a:EthernetInterface>
          <ElementType>DeviceInterface</ElementType>
          <AlternateSpeeds i:nil="true"/>
          <EnableAutoNegotiation>true</EnableAutoNegotiation>
          <EnableFlowControl>true</EnableFlowControl>
          <Index>1</Index>
          <InterfaceName>{{ port_alias[index] }}</InterfaceName>
          <InterfaceType i:nil="true"/>
          <MultiPortsInterface>false</MultiPortsInterface>
          <PortName>0</PortName>
          <Priority>0</Priority>
{% set speed_option = port_speed | length %}
{% if speed_option == 0 %}
          <Speed>{{ iface_speed }}</Speed>
{% else %}
          <Speed>{{ port_speed[index] }}</Speed>
{% endif %}
        </a:EthernetInterface>
{% endfor %}
      </EthernetInterfaces>
      <FlowControl>true</FlowControl>
      <Height>0</Height>
      <HwSku>{{ hwsku }}</HwSku> 
      <ManagementInterfaces/>
    </DeviceInfo> 
  </DeviceInfos>
  <MetadataDeclaration>
{% set syslog_servers_str=';'.join(syslog_servers) %}
{% set dhcp_servers_str=';'.join(dhcp_servers) %}
{% set forced_mgmt_routes_str = ';'.join(forced_mgmt_routes)  %}
{% set ntp_servers_str = ';'.join(ntp_servers) %}
{% set snmp_servers_str = ';'.join(snmp_servers) %}
{% set tacacs_servers_str = ';'.join(tacacs_servers) %}
{% set radius_servers_str = ';'.join(radius_servers) %}
{% set erspan_dest_str = ';'.join(erspan_dest) %}
    <Devices xmlns:a="http://schemas.datacontract.org/2004/07/Microsoft.Search.Autopilot.Evolution">
      <a:DeviceMetadata>
        <a:Name>{{ inventory_hostname }}</a:Name>
        <a:Properties>
          <a:DeviceProperty>
            <a:Name>DhcpResources</a:Name>
            <a:Reference i:nil="true"/>
            <a:Value>{{ dhcp_servers_str }}</a:Value>
          </a:DeviceProperty>
          <a:DeviceProperty>
            <a:Name>NtpResources</a:Name>
            <a:Reference i:nil="true"/>
            <a:Value>{{ ntp_servers_str }}</a:Value>
          </a:DeviceProperty>
          <a:DeviceProperty>
            <a:Name>DeploymentId</a:Name>
            <a:Reference i:nil="true"/>
            <a:Value>1</a:Value>
          </a:DeviceProperty>
          <a:DeviceProperty>
            <a:Name>QosProfile</a:Name>
            <a:Reference i:nil="true"/>
            <a:Value>Profile0</a:Value>
          </a:DeviceProperty>
          <a:DeviceProperty>
            <a:Name>RadiusResources</a:Name>
            <a:Reference i:nil="true"/>
            <a:Value>{{ radius_servers_str }}</a:Value>
          </a:DeviceProperty>
          <a:DeviceProperty>
            <a:Name>SnmpResources</a:Name>
            <a:Reference i:nil="true"/>
            <a:Value>{{ snmp_servers_str }}</a:Value>
          </a:DeviceProperty>
          <a:DeviceProperty>
            <a:Name>SyslogResources</a:Name>
            <a:Reference i:nil="true"/>
            <a:Value>{{ syslog_servers_str }}</a:Value>
          </a:DeviceProperty>
          <a:DeviceProperty>
            <a:Name>TacacsGroup</a:Name>
            <a:Reference i:nil="true"/>
            <a:Value>{{ tacacs_group }}</a:Value>
          </a:DeviceProperty>
          <a:DeviceProperty>
            <a:Name>TacacsServer</a:Name>
            <a:Reference i:nil="true"/>
            <a:Value>{{ tacacs_servers_str }}</a:Value>
          </a:DeviceProperty>
          <a:DeviceProperty>
            <a:Name>ForcedMgmtRoutes</a:Name>
            <a:Reference i:nil="true"/>
            <a:Value>{{ forced_mgmt_routes_str }}</a:Value>
          </a:DeviceProperty>
          <a:DeviceProperty>
            <a:Name>ErspanDestinationIpv4</a:Name>
            <a:Reference i:nil="true"/>
            <a:Value>{{ erspan_dest_str }}</a:Value>
         </a:DeviceProperty>
        </a:Properties>
      </a:DeviceMetadata>
    </Devices>
    <Properties xmlns:a="http://schemas.datacontract.org/2004/07/Microsoft.Search.Autopilot.Evolution"/>
  </MetadataDeclaration>
  <Hostname>{{ inventory_hostname }}</Hostname>
  <HwSku>{{ hwsku }}</HwSku>
</DeviceMiniGraph>
