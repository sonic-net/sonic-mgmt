# This job is for periodically auto recovery testbed 

name:  AutoRecovery_$(Build.DefinitionName)_$(SourceBranchName)_$(Build.BuildId)_$(Date:yyyyMMdd)$(Rev:.r)

trigger: none
pr: none

# schedules:
#   - cron: "9 */4 * * *"    # trigger every 4 hours, start at random minutes (9)
#     displayName: AutoRecoveryTestbedsScheduler
#     branches:
#       include:
#         - internal
#     always: true

parameters:
  - name: SANITY_CHECK
    type: boolean
    default: true
    displayName: "do sanity check"

  - name: TESTBEDS_NAME
    type: string
    displayName: "testbeds name for recover"

stages:
  - stage: AutoRecovery
    jobs:
      - job: AutoRecovery_Starlab
        pool: nightly
        timeoutInMinutes: 180
        variables:
          - group: KUSTO_SECRETS
          - group: GIT_SECRETS
          - group: NIGHTLY_HAWK
          - group: TBSHARE_SECRETS
          - group: SECRETS_JSON
          - name: skipComponentGovernanceDetection
            value: true

        steps:

          - template: ../.azure-pipelines/nightly/templates/get_secrets.yml

          - task: Bash@3
            displayName: Run auto recovery script
            inputs:
              targetType: 'inline'
              script: |
                set -x
                source /var/AzDevOps/env-python3/bin/activate

                cd test_analyzer
                pip3 install -r requirements.txt              

                echo 'nightly pool, testbeds name' 
                echo '${{ parameters.TESTBEDS_NAME }}'

                if [[ ${{ parameters.SANITY_CHECK }} == True ]]; then
                    python3 nightly_hawk_autoRecovery.py -v -s -g -n '${{ parameters.TESTBEDS_NAME }}' -p 'nightly' -extb $(EXCLUDED_TESTBED_KEYWORDS)
                else
                    echo "skip do sanity check"
                    python3 nightly_hawk_autoRecovery.py -v -g -n '${{ parameters.TESTBEDS_NAME }}' -p 'nightly' -extb $(EXCLUDED_TESTBED_KEYWORDS)
                fi
                
            env:
              TBSHARE_AAD_CLIENT_ID: $(TBSHARE_AAD_CLIENT_ID)
              TBSHARE_AAD_CLIENT_SECRET: $(TBSHARE_AAD_CLIENT_SECRET)
              TEST_REPORT_INGEST_KUSTO_CLUSTER_BACKUP: $(TEST_REPORT_INGEST_KUSTO_CLUSTER_BACKUP)
              TEST_REPORT_AAD_TENANT_ID_BACKUP: $(TEST_REPORT_AAD_TENANT_ID_BACKUP)
              TEST_REPORT_AAD_CLIENT_ID_BACKUP: $(TEST_REPORT_AAD_CLIENT_ID_BACKUP)
              TEST_REPORT_AAD_CLIENT_KEY_BACKUP: $(TEST_REPORT_AAD_CLIENT_KEY_BACKUP)
              AZURE_DEVOPS_MSAZURE_TOKEN: $(AZURE_DEVOPS_MSAZURE_TOKEN)
              AZURE_DEVOPS_MSSONIC_TOKEN: $(MSSONIC_TOKEN_NIGHTLY_HAWK)

      - job: AutoRecovery_bjwLab
        pool: nightly-bjw
        timeoutInMinutes: 180
        variables:
          - group: KUSTO_SECRETS
          - group: GIT_SECRETS
          - group: NIGHTLY_HAWK
          - group: TBSHARE_SECRETS
          - group: SECRETS_JSON
          - name: skipComponentGovernanceDetection
            value: true

        steps:

          - template: ../.azure-pipelines/nightly/templates/get_secrets.yml

          - task: Bash@3
            displayName: Run auto recovery script
            inputs:
              targetType: 'inline'
              script: |
                set -x
                source /var/AzDevOps/env-python3/bin/activate

                cd test_analyzer
                pip3 install -r requirements.txt              

                echo 'bjw pool, testbeds name' 
                echo '${{ parameters.TESTBEDS_NAME }}'

                if [[ ${{ parameters.SANITY_CHECK }} == True ]]; then
                    python3 nightly_hawk_autoRecovery.py -v -s -g -n '${{ parameters.TESTBEDS_NAME }}'  -p 'nightly-bjw' -extb $(EXCLUDED_TESTBED_KEYWORDS)
                else
                    echo "skip do sanity check"
                    python3 nightly_hawk_autoRecovery.py -v -g -n '${{ parameters.TESTBEDS_NAME }}' -p 'nightly-bjw' -extb $(EXCLUDED_TESTBED_KEYWORDS)
                fi
                
            env:
              TBSHARE_AAD_CLIENT_ID: $(TBSHARE_AAD_CLIENT_ID)
              TBSHARE_AAD_CLIENT_SECRET: $(TBSHARE_AAD_CLIENT_SECRET)
              TEST_REPORT_INGEST_KUSTO_CLUSTER_BACKUP: $(TEST_REPORT_INGEST_KUSTO_CLUSTER_BACKUP)
              TEST_REPORT_AAD_TENANT_ID_BACKUP: $(TEST_REPORT_AAD_TENANT_ID_BACKUP)
              TEST_REPORT_AAD_CLIENT_ID_BACKUP: $(TEST_REPORT_AAD_CLIENT_ID_BACKUP)
              TEST_REPORT_AAD_CLIENT_KEY_BACKUP: $(TEST_REPORT_AAD_CLIENT_KEY_BACKUP)
              AZURE_DEVOPS_MSAZURE_TOKEN: $(AZURE_DEVOPS_MSAZURE_TOKEN)
              AZURE_DEVOPS_MSSONIC_TOKEN: $(MSSONIC_TOKEN_NIGHTLY_HAWK)

      - job: AutoRecovery_svc
        pool: nightly-svc
        timeoutInMinutes: 180
        variables:
          - group: KUSTO_SECRETS
          - group: GIT_SECRETS
          - group: NIGHTLY_HAWK
          - group: TBSHARE_SECRETS
          - group: SECRETS_JSON
          - name: skipComponentGovernanceDetection
            value: true

        steps:

          - template: ../.azure-pipelines/nightly/templates/get_secrets.yml

          - task: Bash@3
            displayName: Run auto recovery script
            inputs:
              targetType: 'inline'
              script: |
                set -x
                source /var/AzDevOps/env-python3/bin/activate

                cd test_analyzer
                pip3 install -r requirements.txt              

                echo 'svc pool, testbeds name' 
                echo '${{ parameters.TESTBEDS_NAME }}'

                if [[ ${{ parameters.SANITY_CHECK }} == True ]]; then
                    python3 nightly_hawk_autoRecovery.py -v -s -g -n '${{ parameters.TESTBEDS_NAME }}' -p 'nightly-svc' -extb $(EXCLUDED_TESTBED_KEYWORDS)
                else
                    echo "skip do sanity check"
                    python3 nightly_hawk_autoRecovery.py -v -g -n '${{ parameters.TESTBEDS_NAME }}' -p 'nightly-svc' -extb $(EXCLUDED_TESTBED_KEYWORDS)
                fi
                
            env:
              TBSHARE_AAD_CLIENT_ID: $(TBSHARE_AAD_CLIENT_ID)
              TBSHARE_AAD_CLIENT_SECRET: $(TBSHARE_AAD_CLIENT_SECRET)
              TEST_REPORT_INGEST_KUSTO_CLUSTER_BACKUP: $(TEST_REPORT_INGEST_KUSTO_CLUSTER_BACKUP)
              TEST_REPORT_AAD_TENANT_ID_BACKUP: $(TEST_REPORT_AAD_TENANT_ID_BACKUP)
              TEST_REPORT_AAD_CLIENT_ID_BACKUP: $(TEST_REPORT_AAD_CLIENT_ID_BACKUP)
              TEST_REPORT_AAD_CLIENT_KEY_BACKUP: $(TEST_REPORT_AAD_CLIENT_KEY_BACKUP)
              AZURE_DEVOPS_MSAZURE_TOKEN: $(AZURE_DEVOPS_MSAZURE_TOKEN)
              AZURE_DEVOPS_MSSONIC_TOKEN: $(MSSONIC_TOKEN_NIGHTLY_HAWK)