# This job is for periodically polling testbed health and upload polling results to Kusto

name: $(Build.DefinitionName)_$(SourceBranchName)_$(Build.BuildId)_$(Date:yyyyMMdd)$(Rev:.r)

trigger: none
pr: none

schedules:
  - cron: "15,45 * * * *"
    displayName: MigrateKustoData
    branches:
      include:
        - internal
    always: true

parameters:
  - name: TESTPLAN_IDS
    type: string
    default: " "
    displayName: "Testplan IDs which are missing in Kusto, separated by comma, such as aaa,bbb,ccc"

stages:
  - stage: KustoDataMigrting
    jobs:
      - job: KustoDataMigrting
        timeoutInMinutes: 60
        variables:
          - group: KUSTO_SECRETS
          - name: skipComponentGovernanceDetection
            value: true

        steps:

          - task: AzureCLI@2
            displayName: Run migration script
            inputs:
              azureSubscription: "SONiC-Automation"
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                pwd

                accessToken=$(az account get-access-token --resource https://api.kusto.windows.net --query accessToken -o tsv)
                export ACCESS_TOKEN=$accessToken

                set -x

                source /var/AzDevOps/env-python3/bin/activate

                cd test_analyzer
                pip3 install -r requirements.txt

                if [ "${{ parameters.TESTPLAN_IDS }}" != " " ]; then
                  python3 migrate_kusto_data.py -t "${{ parameters.TESTPLAN_IDS }}"
                else
                  python3 migrate_kusto_data.py
                fi
            env:
              TEST_REPORT_INGEST_KUSTO_CLUSTER_BACKUP: $(TEST_REPORT_INGEST_KUSTO_CLUSTER_BACKUP)
