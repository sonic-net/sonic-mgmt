# This job is for periodically polling testbed health and upload polling results to Kusto

name: $(Build.DefinitionName)_$(SourceBranchName)_$(Build.BuildId)_$(Date:yyyyMMdd)$(Rev:.r)

trigger: none
pr: none

schedules:
  - cron: "0 2 * * 1-5"
    displayName: TestFailureAnalyzingScheduler
    branches:
      include:
        - internal
    always: true

stages:
  - stage: TestFailureAnalyzing
    jobs:
      - job: TestFailureAnalyzing
        pool: nightly
        timeoutInMinutes: 350
        variables:
          - group: KUSTO_SECRETS
          - group: NIGHTLY_HAWK
          - name: skipComponentGovernanceDetection
            value: true

        steps:
          - task: AzureCLI@2
            displayName: Run analyzer script
            inputs:
              azureSubscription: "SONiC-Automation"
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                pwd

                KustoAccessToken=$(az account get-access-token --resource https://api.kusto.windows.net --query accessToken -o tsv)
                export ACCESS_TOKEN=$KustoAccessToken
                ADOAccessToken=$(az account get-access-token --resource 499b84ac-1321-427f-aa17-267ca6975798 --query accessToken --output tsv)
                export AZURE_DEVOPS_MSAZURE_TOKEN=$ADOAccessToken

                set -x
                python3 -m venv /var/AzDevOps/env-python3
                source /var/AzDevOps/env-python3/bin/activate
                cd test_analyzer/failure_analyzer
                mkdir logs
                touch logs/analyzer.log
                pip install -r requirements.txt

                python3 main.py \
                  -extb $(EXCLUDED_TESTBED_KEYWORDS) \
                  -exerr $(EXCLUDED_TESTBED_KEYWORDS_SETUP_ERROR) \
                  -incbr '$(INCLUDED_BRANCH)' \
                  -rlsbr '$(RELEASED_BRANCH)' \
                  -u \
                  2>&1 | tee logs/analyzer.log
            env:
              TEST_REPORT_INGEST_KUSTO_CLUSTER_BACKUP: $(TEST_REPORT_INGEST_KUSTO_CLUSTER_BACKUP)
              AZURE_OPENAI_ENDPOINT: $(AZURE_OPENAI_ENDPOINT)
              AZURE_OPENAI_API: $(AZURE_OPENAI_API)

          - publish: test_analyzer/failure_analyzer/logs
            displayName: "Archive test logs"
            artifact: TestFailureAnalyzing.log@$(System.JobAttempt)
            condition: always()
