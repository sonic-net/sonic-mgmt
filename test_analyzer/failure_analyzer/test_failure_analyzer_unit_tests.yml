pr:
   branches:
     include:
       - internal
   paths:
     include:
       - test_analyzer/failure_analyzer/**

trigger:
  branches:
    include:
    - internal
  paths:
    include:
    - test_analyzer/failure_analyzer/**

variables:
- group: KUSTO_SECRETS
- group: NIGHTLY_HAWK
- name: skipComponentGovernanceDetection
  value: true
- name: vmImageName
  value: 'ubuntu-latest'
- name: projectSubDirectory
  value: 'test_analyzer/failure_analyzer'
- name: projectRoot
  value: '$(System.DefaultWorkingDirectory)/$(projectSubDirectory)'
- name: virtualEnvName
  value: 'fail-analyzer-venv'
- name: baseBranch
  value: 'internal'
- name: pythonVersion
  value: '3.8'

jobs:
- job: CheckForChanges
  displayName: 'Check for changes in the test failure analyzer'
  pool:
    vmImage: $(vmImageName)
  steps:
  - script: |
      CHANGED_FILES=$(git diff --name-only origin/$(baseBranch)...HEAD)

      echo "Files changed are:"
      echo "------------------"
      echo "$CHANGED_FILES"
      echo "------------------"
      echo ""

      if echo "$CHANGED_FILES" | grep -q '^$(projectSubDirectory)/'; then
        echo "Test failure analyzer code has been modified, running unit tests"
        echo "##vso[task.setvariable variable=RUN_PIPELINE;isOutput=true]true"
      else
        echo "Test failure analyzer code has not been modified, skipping unit tests"
        echo "##vso[task.setvariable variable=RUN_PIPELINE;isOutput=true]false"
      fi
    name: CheckChanges

- job: RunUnitTests
  displayName: 'Run test failure analyzer unit tests'
  dependsOn: CheckForChanges
  condition: eq(dependencies.CheckForChanges.outputs['CheckChanges.RUN_PIPELINE'], 'true')
  pool:
    vmImage: $(vmImageName)
  steps:
  - task: UsePythonVersion@0
    inputs:
      versionSpec: '$(pythonVersion)'
    displayName: 'Use Python $(pythonVersion)'

  - script: |
      python -m venv $(virtualEnvName)
      source $(virtualEnvName)/bin/activate
      python -m pip install --upgrade pip
      pip install -r requirements.txt
    workingDirectory: $(projectRoot)
    displayName: "Install dependencies"

  - task: AzureCLI@2
    displayName: Run tests
    inputs:
      azureSubscription: "SONiC-Automation"
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        source $(virtualEnvName)/bin/activate

        KustoAccessToken=$(az account get-access-token --resource https://api.kusto.windows.net --query accessToken -o tsv)
        export ACCESS_TOKEN=$KustoAccessToken
        ADOAccessToken=$(az account get-access-token --resource 499b84ac-1321-427f-aa17-267ca6975798 --query accessToken --output tsv)
        export AZURE_DEVOPS_MSAZURE_TOKEN=$ADOAccessToken

        python -m pytest \
          -o log_cli=true -o log_cli_level=info \
          --cov=. --cov-report=html --cov-report=xml \
          --extb $(EXCLUDED_TESTBED_KEYWORDS) \
          --exerr $(EXCLUDED_TESTBED_KEYWORDS_SETUP_ERROR) \
          --incbr '$(INCLUDED_BRANCH)' \
          --rlsbr '$(RELEASED_BRANCH)'
      workingDirectory: $(projectRoot)
    env:
      TEST_REPORT_INGEST_KUSTO_CLUSTER_BACKUP: $(TEST_REPORT_INGEST_KUSTO_CLUSTER_BACKUP)

  # Leave at version 1 - version 2 has strange behaviour with how it parses file paths
  - task: PublishCodeCoverageResults@1
    inputs:
      codeCoverageTool: Cobertura
      summaryFileLocation: '$(projectRoot)/coverage.xml'
      reportDirectory: '$(projectRoot)/htmlcov/'
    displayName: 'Publish Python 3 test coverage'
