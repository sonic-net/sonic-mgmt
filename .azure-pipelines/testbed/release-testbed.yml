# This job is for releasing a testbed when we can't release it from the testbed booking system.

name: ReleaseTestbed_$(Build.DefinitionName)_$(SourceBranchName)_$(Build.BuildId)_$(Date:yyyyMMdd)$(Rev:.r)

trigger: none
pr: none

parameters:
  - name: TESTBED_NAME
    type: string
    displayName: "Testbed name"

  - name: AGENT_POOL
    type: string
    default: nightly
    values:
      - nightly
      - nightly-svc
      - nightly-bjw
      - nightly-tk5

stages:
  - stage: ReleaseTestbed
    jobs:
      - job: ReleaseTestbed
        pool: ${{ parameters.AGENT_POOL }}
        timeoutInMinutes: 30
        workspace:
          clean: all
        variables:
          - group: TBSHARE_SECRETS
          - name: skipComponentGovernanceDetection
            value: true
        steps:

          - task: AzureCLI@2
            inputs:
              azureSubscription: "SONiC-Automation"
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                pwd

                accessToken=$(az account get-access-token --resource "$(ELASTICTEST_MSAL_CLIENT_ID)" --query accessToken -o tsv)
                export ACCESS_TOKEN=$accessToken

                python ./.azure-pipelines/nightly/templates/lock_release.py -t ${{ parameters.TESTBED_NAME }} -a release -R
            displayName: Release Testbed
