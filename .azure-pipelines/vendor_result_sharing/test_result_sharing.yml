# This job is for periodically querying highest passing rate test result and upload to azure storage

name: $(Build.DefinitionName)_$(Build.BuildId)_$(Date:yyyyMMdd)$(Rev:.r)

trigger: none
pr: none

schedules:
  - cron: "15 0 * * Sun"
    displayName: Test Result Sharing With Vendor Scheduler
    branches:
      include:
        - internal
    always: true

pool:
  vmImage: ubuntu-latest

parameters:
  - name: HARDWARESKU
    type: string
    default: 'All'
    displayName: "Hardware SKU"

  - name: TOPOLGY_TYPE
    type: string
    default: 'All'
    displayName: "Topology Type, t0 or t1"

  - name: BRANCH
    type: string
    default: 'All'
    displayName: "Branch name, 20230531 or 20231105"

  - name: BUILD_ID
    type: string
    default: 'All'
    displayName: "Build ID"

stages:
  - stage: TestResultSharingWithVendor
    jobs:
      - job: TestResultSharingWithVendor
        pool: nightly
        timeoutInMinutes: 240
        variables:
          - group: KUSTO_SECRETS
          - group: GIT_SECRETS
          - name: skipComponentGovernanceDetection
            value: true

        steps:

          - task: Bash@3
            displayName: Run test_result_sharing.py script
            inputs:
              targetType: 'inline'
              script: |
                set -x

                source /var/AzDevOps/env-python3/bin/activate

                cd .azure-pipelines/vendor_result_sharing
                pip3 install -r requirements.txt

                python3 test_result_sharing.py -t ${{ parameters.TOPOLGY_TYPE }} -b ${{ parameters.BRANCH }} -i ${{ parameters.BUILD_ID }} -s ${{ parameters.HARDWARESKU }}

            env:
              TEST_REPORT_INGEST_KUSTO_CLUSTER_BACKUP: $(TEST_REPORT_INGEST_KUSTO_CLUSTER_BACKUP)
              TEST_REPORT_AAD_TENANT_ID_BACKUP: $(TEST_REPORT_AAD_TENANT_ID_BACKUP)
              TEST_REPORT_AAD_CLIENT_ID_BACKUP: $(TEST_REPORT_AAD_CLIENT_ID_BACKUP)
              TEST_REPORT_AAD_CLIENT_KEY_BACKUP: $(TEST_REPORT_AAD_CLIENT_KEY_BACKUP)
              VENDOR_SHARING_SAS_TOKEN: $(VENDOR_SHARING_SAS_TOKEN)
              NIGHTLY_TEST_SAS_TOKEN: $(NIGHTLY_TEST_SAS_TOKEN)
