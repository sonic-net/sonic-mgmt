# This job is for periodically querying highest passing rate test result and upload to azure storage

name: $(Build.DefinitionName)_$(Build.BuildId)_$(Date:yyyyMMdd)$(Rev:.r)

trigger: none
pr: none

schedules:
  - cron: "15 0 * * Sun"
    displayName: Test Result Sharing With Vendor Scheduler_PipelineTest
    branches:
      include:
        - internal
    always: true

parameters:
  - name: 'VENDOR'
    type: object
    displayName: "Vendor Name"
    default:
      - arista

  - name: HARDWARESKU
    type: string
    default: 'All'
    displayName: "Hardware SKU"

  - name: TOPOLGY_TYPE
    type: string
    default: 'dualtor'
    displayName: "Topology Type, t0, t1, mx or dualtor"

  - name: BRANCH
    type: string
    default: 'All'
    displayName: "Branch name, 20230531, 20231110, 20240531, 20240510"

  - name: BUILD_ID
    type: string
    default: 'All'
    displayName: "Build ID"

stages:
  - stage: TestResultSharingWithVendor_dualtor
    jobs:
      - ${{ each vendor in parameters.VENDOR }}:
        - job: ${{ vendor }}_TestResultSharingWithVendor_dualtor
          pool: nightly
          timeoutInMinutes: 960
          variables:
            - group: KUSTO_SECRETS
            - group: sonicbld
            - name: skipComponentGovernanceDetection
              value: true

          steps:

            - task: AzureCLI@2
              displayName: Run test_result_sharing.py script
              inputs:
                azureSubscription: "SONiC-Automation"
                scriptType: 'bash'
                scriptLocation: 'inlineScript'
                inlineScript: |
                  accessToken=$(az account get-access-token --resource https://api.kusto.windows.net --query accessToken -o tsv)
                  export ACCESS_TOKEN=$accessToken

                  accessTokenForVendor=$(az account get-access-token --resource https://sonicvendorresult.blob.core.windows.net/ --query accessToken -o tsv)
                  export VENDOR_SHARING_TOKEN=$accessTokenForVendor

                  accessTokenForNightly=$(az account get-access-token --resource https://sonicelastictestprodsa.blob.core.windows.net/ --query accessToken -o tsv)
                  export NIGHTLY_TEST_TOKEN=$accessTokenForNightly

                  set -x

                  cd .azure-pipelines/vendor_result_sharing
                  pip3 install -r requirements.txt

                  python3 test_result_sharing.py -t ${{ parameters.TOPOLGY_TYPE }} -b ${{ parameters.BRANCH }} -i ${{ parameters.BUILD_ID }} -s ${{ parameters.HARDWARESKU }} -v ${{ vendor }}

              env:
                TEST_REPORT_INGEST_KUSTO_CLUSTER_BACKUP: $(TEST_REPORT_INGEST_KUSTO_CLUSTER_BACKUP)
                VENDOR_SHARING_TOKEN: $(VENDOR_SHARING_TOKEN)
                NIGHTLY_TEST_TOKEN: $(NIGHTLY_TEST_TOKEN)
                AZURE_DEVOPS_PAT_FOR_DUALTOR_RESULT: $(MSSONIC-TOKEN)
