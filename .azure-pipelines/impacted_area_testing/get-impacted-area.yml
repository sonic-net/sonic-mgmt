parameters:
  - name: BUILD_BRANCH
    type: string
    default: 'master'
  - name: TARGET_BRANCH
    type: string
    default: 'origin/master'
  - name: SOURCE_BRANCH
    type: string
    default: ''
  - name: IMPACT_AREA_INFO
    type: object
    default: {}
  - name: AST_ROLLOUT_PERCENTAGE
    displayName: "AST Rollout Percentage (0-100)"
    type: number
    default: 0
  - name: FROM_BUILDIMAGE
    type: boolean
    default: false

steps:
- script: |
    echo "##vso[task.setvariable variable=BUILD_BRANCH]${{ parameters.BUILD_BRANCH }}"
    sudo apt-get -o DPkg::Lock::Timeout=600 -y install jq

    # Routing decision
    FROM_BUILDIMAGE="${{ parameters.FROM_BUILDIMAGE }}"
    AST_PCT=${{ parameters.AST_ROLLOUT_PERCENTAGE }}

    # Always use legacy for buildimage PRs
    if [[ "$FROM_BUILDIMAGE" == "True" ]] || [[ "$FROM_BUILDIMAGE" == "true" ]]; then
      USE_AST="false"
      echo "→ FROM_BUILDIMAGE=true: Using Legacy implementation"
    elif [[ $AST_PCT -eq 100 ]]; then
      USE_AST="true"
      echo "→ AST Rollout: 100% - Using AST implementation"
    elif [[ $AST_PCT -gt 0 ]] && [[ $((1 + RANDOM % 100)) -le $AST_PCT ]]; then
      USE_AST="true"
      echo "→ AST Rollout: ${AST_PCT}% - Randomly selected AST implementation"
    else
      USE_AST="false"
      echo "→ AST Rollout: ${AST_PCT}% - Using Legacy implementation"
    fi

    echo "##vso[task.setvariable variable=USE_AST]$USE_AST"
  displayName: "Setup & routing decision"

- ${{ if and(ne(parameters.IMPACT_AREA_INFO, ''), ne(length(parameters.IMPACT_AREA_INFO), 0)) }}:
  - script: |
      IMPACT_AREA_INFO='${{ convertToJson(parameters.IMPACT_AREA_INFO) }}'
      echo "Input impact area info: $IMPACT_AREA_INFO"
      TEST_SCRIPTS=$(echo "$IMPACT_AREA_INFO" | jq -c '.')
      PR_CHECKERS=$(echo "${TEST_SCRIPTS}" | jq -c 'keys')
      echo "Impact area was pre-defined."
      echo "Impact area info: $IMPACT_AREA_INFO"
      echo "Pre-defined test scripts: ${TEST_SCRIPTS}"
      echo "Pre-defined PR checkers: ${PR_CHECKERS}"
      echo "##vso[task.setvariable variable=PR_CHECKERS;isOutput=true]${PR_CHECKERS}"
      echo "##vso[task.setvariable variable=TEST_SCRIPTS;isOutput=true]${TEST_SCRIPTS}"
    name: VerifyParams
    displayName: "Process pre-defined impact area"
- ${{ else }}:
  - script: |
      echo "Impact area was not pre-defined."
      TEST_SCRIPTS=""
      PR_CHECKERS=""
      echo "##vso[task.setvariable variable=PR_CHECKERS;isOutput=true]${PR_CHECKERS}"
      echo "##vso[task.setvariable variable=TEST_SCRIPTS;isOutput=true]${TEST_SCRIPTS}"
    name: VerifyParams
    displayName: "Set empty impact area variables"


- script: |
    set -e
    set -u
    set -o pipefail

    TEST_SCRIPTS='$(VerifyParams.TEST_SCRIPTS)'
    PR_CHECKERS='$(VerifyParams.PR_CHECKERS)'
    USE_AST='$(USE_AST)'

    # Skip if pre-defined
    if [[ -n "$TEST_SCRIPTS" && -n "$PR_CHECKERS" ]]; then
      echo "Impact area was pre-defined, skip analysis."
      echo "##vso[task.setvariable variable=PR_CHECKERS;isOutput=true]$PR_CHECKERS"
      echo "##vso[task.setvariable variable=TEST_SCRIPTS;isOutput=true]$TEST_SCRIPTS"
      exit 0
    fi

    # Export BUILD_BRANCH for bash scripts
    export BUILD_BRANCH="${{ parameters.BUILD_BRANCH }}"

    # Route to selected implementation
    if [ "$USE_AST" = "true" ]; then
      echo "→ Executing AST-based analysis..."
      bash $(Build.SourcesDirectory)/.azure-pipelines/impacted_area_testing/impl-ast.sh
    else
      echo "→ Executing Legacy directory-based analysis..."
      bash $(Build.SourcesDirectory)/.azure-pipelines/impacted_area_testing/impl-legacy.sh
    fi

  name: SetVariableTask
  continueOnError: false
  displayName: "Get impacted area"
