steps:
  - script: |
      # Install dependencies
      pip install pytest pytest-cov coverage

      # Ensure make is available (most Ubuntu agents have it, but just in case)
      if ! command -v make &> /dev/null; then
        echo "Installing make..."
        sudo apt-get -o DPkg::Lock::Timeout=180 update && sudo apt-get -o DPkg::Lock::Timeout=180 install -y make
      fi

      # Source the shared script to get changed Python files
      source .azure-pipelines/common2/scripts/get-changed-python-files.sh

      if [ "$HAS_CHANGED_PYTHON_FILES" = "false" ]; then
        echo "Skipping Unit Tests with Coverage Check."
      else
        echo "Running Unit Tests with Coverage Enforcement for tests/common2..."
        # Change to the tests/common2 directory and use the Makefile target
        # This will run unit tests and enforce 80% coverage for each module
        cd tests/common2 && make coverage-enforce
      fi
    displayName: 'Run Unit Tests with Coverage Enforcement (conditional)'
