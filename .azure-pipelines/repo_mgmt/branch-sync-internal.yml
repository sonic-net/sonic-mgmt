
name: InternalSyncAndMerge_$(Build.DefinitionName)_$(SourceBranchName)_$(Build.BuildId)_$(Date:yyyyMMdd)$(Rev:.r)

trigger: none
pr: none

schedules:
  - cron: "0 3 * * *"
    displayName: Internal Sync and Merge
    branches:
      include:
        - internal
    always: true

parameters:
  - name: InternalSyncJobs
    type: object
    default:
      Chassis_202503_internal:
        SOURCE_BRANCH: "internal-202412"
        TARGET_BRANCH: "internal-202503-chassis"
        PUSH_BRANCH: "internal-202503-chassis"
    displayName: "Branches to sync and merge"

stages:
  - stage: InternalSyncAndMerge
    jobs:
      - job: InternalSyncBranches
        strategy:
          maxParallel: 5
          matrix:
            ${{ parameters.InternalSyncJobs }}

        steps:
          - checkout: self
            persistCredentials: true

          - script: |
              set -ex

              echo "=== Prepare git branchs for merge ==="
              git config --global user.email "mssonic@microsoft.com"
              git config --global user.name "Internal Build Service"

              git fetch origin

              echo "Checkout a temp branch 'foo', so that we can cleanup the branches to be worked on."
              git checkout -b foo origin/internal || true
              git branch -D $(TARGET_BRANCH) || true

              echo "Checkout the target branch to be worked on."
              git checkout -b $(TARGET_BRANCH) origin/$(TARGET_BRANCH)
              git branch -D foo || true  # Cleanup the temp 'foo' branch.
            displayName: Prepare git

          - script: |
              set -ex

              echo "=== Sync source branch to target branch ==="
              git merge --no-edit origin/$(SOURCE_BRANCH)
            displayName: "Merge branch"

          - script: |
              set -ex

              echo "=== Push the merged branch to remote ==="
              git push origin $(TARGET_BRANCH):$(PUSH_BRANCH)
            displayName: "Push branch"
