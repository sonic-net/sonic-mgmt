# This pipeline is run Elastictest nightly test for sonic-vpp image
# The sonic-vpp image build pipeline is sonic-net.sonic-buildimage.official.vpp (pipelineId=2818)

name: $(TeamProject)_$(Build.DefinitionName)_$(SourceBranchName)_$(Date:yyyyMMdd)$(Rev:.r)

trigger: none

schedules:
  - cron: "0 0 * * *"
    displayName: "SONiC-VPP Nightly Test"
    branches:
      include:
        - master

resources:
  repositories:
    - repository: sonic-mgmt
      type: github
      name: sonic-net/sonic-mgmt
      ref: master
      endpoint: sonic-net

stages:
  - stage: Test
    variables:
      - group: SONiC-Elastictest
      - name: inventory
        value: veos_vtb
      - name: testbed_file
        value: vtestbed.yaml
      - name: BUILD_BRANCH
        value: $(Build.SourceBranchName)

    jobs:
      - job: t1_lag_vpp_elastictest
        displayName: "kvmtest-t1-lag-vpp by Elastictest"
        timeoutInMinutes: 480
        continueOnError: false
        pool: sonic-ubuntu-1c
        steps:
          - template: .azure-pipelines/run-test-elastictest-template.yml@sonic-mgmt
            parameters:
              TOPOLOGY: t1-lag-vpp
              MIN_WORKER: $(T1_LAG_VPP_INSTANCE_NUM)
              MAX_WORKER: $(T1_LAG_VPP_INSTANCE_NUM)
              KVM_IMAGE_BRANCH: $(BUILD_BRANCH)
              MGMT_BRANCH: $(BUILD_BRANCH)
              ASIC_TYPE: "vpp"
              KVM_IMAGE_BUILD_PIPELINE_ID: "2818"
              COMMON_EXTRA_PARAMS: "--disable_sai_validation --disable_loganalyzer"
              STOP_ON_FAILURE: "False"
