steps:

- task: DockerInstaller@0
  inputs:
    dockerVersion: '20.10.23'
  displayName: 'Install Docker'

- checkout: self
  clean: true
  displayName: 'Checkout sonic-mgmt repo'

- script: |
    set -x

    sudo /agent/_work/_tool/docker-stable/20.10.23/x64/docker pull \
      sonicdev-microsoft.azurecr.io:443/docker-sonic-mgmt:latest

    sudo /agent/_work/_tool/docker-stable/20.10.23/x64/docker run -dt --name sonic-mgmt-collect \
      -v $(System.DefaultWorkingDirectory):/var/src/sonic-mgmt \
      sonicdev-microsoft.azurecr.io:443/docker-sonic-mgmt:latest \
      /bin/bash
  displayName: 'Prepare sonic-mgmt docker container'

- script: |
    set -x

    sudo /agent/_work/_tool/docker-stable/20.10.23/x64/docker exec -t -w /var/src/sonic-mgmt/tests sonic-mgmt-collect \
      pytest --inventory ../ansible/veos_vtb --host-pattern all \
      --testbed_file vtestbed.yaml --testbed vms-kvm-t0 \
      --ignore saitests --ignore ptftests --ignore acstests \
      --ignore scripts --ignore k8s --ignore sai_qualify --ignore common \
      --ignore-conditional-mark \
      --color=no --collect-only --continue-on-collection-errors
  displayName: 'Run pytest --collect-only'
